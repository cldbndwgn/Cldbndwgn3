<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>cldcipher — Learn Ethical Hacking</title>
<meta name="description" content="cldcipher — free ethical hacking curriculum (demo SPA, browser-only storage)" />
<style>
  /* ---- base / reset ---- */
  :root{
    --accent:#2563eb; --bg:#071028; --panel:#0b1220; --muted:#9aa4b2;
    --glass: rgba(255,255,255,0.03); --success:#16a34a; --danger:#ef4444;
    --maxw:1100px;
  }
  *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg) 0%, #081427 60%);color:#e9f0fb;-webkit-font-smoothing:antialiased}
  a{color:inherit;text-decoration:none}
  button{cursor:pointer}
  .container{max-width:var(--maxw);margin:0 auto;padding:12px}

  /* header */
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
  .brand{font-weight:800;font-size:20px}
  nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .nav-btn{background:transparent;border:0;color:inherit;padding:8px 10px;border-radius:8px}
  .btn{background:var(--accent);color:white;padding:8px 12px;border-radius:10px;border:0}
  .pill{background:var(--glass);padding:8px 10px;border-radius:999px;border:0;color:inherit}

  /* grid */
  .hero{display:flex;gap:16px;align-items:center;padding:16px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  .hero-left{flex:1}
  h1{margin:0;font-size:26px}
  h2{margin:6px 0 0 0;font-size:18px}
  p.muted{color:var(--muted);margin:8px 0 0 0}
  .layout{display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-top:16px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:12px;box-shadow:0 8px 26px rgba(0,0,0,0.6)}
  .small{font-size:13px;color:var(--muted)}

  /* lesson list */
  .lesson-list{display:flex;flex-direction:column;gap:10px}
  .lesson-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:rgba(255,255,255,0.01)}
  .lesson-actions{display:flex;gap:8px;align-items:center}

  /* SPA sections */
  section.app-section{display:none;padding:18px 0 60px 0;min-height:60vh}
  section.app-section.active{display:block}

  /* full-screen lesson view */
  .lesson-view{
    position:fixed;inset:0;background:linear-gradient(180deg, rgba(1,6,20,0.98), rgba(2,6,23,0.99));z-index:1200;padding:12px;overflow:auto;display:none;
  }
  .lesson-top{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .lesson-grid{display:grid;grid-template-columns:1fr 360px;gap:12px;margin-top:12px}
  .module{padding:12px;border-radius:10px;background:rgba(255,255,255,0.01)}
  .submodule{padding:10px;border-radius:8px;background:rgba(255,255,255,0.009);margin-top:8px}
  .progress{height:10px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden}
  .progress > i{display:block;height:100%;background:var(--accent);width:0%}
  .quiz-card{padding:12px;border-radius:10px;background:rgba(255,255,255,0.01);margin-top:12px}
  .quiz-question{padding:8px;border-radius:8px;background:rgba(255,255,255,0.008);margin-bottom:8px}

  /* discussion */
  .discussion{display:flex;flex-direction:column;gap:8px}
  .post{padding:10px;border-radius:8px;background:rgba(255,255,255,0.01)}

  /* footer */
  footer{margin-top:20px;padding:18px;text-align:center;color:var(--muted)}

  /* responsive */
  @media(max-width:980px){
    .layout{grid-template-columns:1fr}
    .lesson-grid{grid-template-columns:1fr;align-items:start}
    .hero{flex-direction:column;align-items:flex-start}
  }
  /* mobile touch targets */
  @media(max-width:420px){
    .btn, .pill, .nav-btn{padding:10px 14px;font-size:15px}
    h1{font-size:22px}
  }

  input,textarea,select{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
  label{font-size:13px;color:var(--muted)}
  .hidden{display:none}
</style>
</head>
<body>
  <header class="container">
    <div class="brand">cldcipher</div>
    <nav id="topnav">
      <button class="nav-btn" data-target="home">Home</button>
      <button class="nav-btn" data-target="lessons">Lessons</button>
      <button class="nav-btn" data-target="quizzes">Quizzes</button>
      <button class="nav-btn" data-target="community">Community</button>
      <button class="nav-btn" data-target="faq">FAQ</button>
      <button id="btn-signup" class="btn">Sign Up</button>
      <button id="btn-login" class="pill">Sign In</button>
    </nav>
  </header>

  <main class="container">
    <!-- HOME -->
    <section id="home" class="app-section active">
      <div class="hero card">
        <div class="hero-left">
          <h1>cldcipher — Learn Ethical Hacking</h1>
          <h2>Ready to Become a Cybersecurity Expert?</h2>
          <p class="muted">Join thousands of learners transforming their careers with a safe, ethical, and defense-first curriculum.</p>
          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="cta-enroll" class="btn">Enroll — Start Free</button>
            <button class="pill" onclick="navigateTo('lessons')">Explore Lessons</button>
          </div>
        </div>
        <div style="width:360px">
          <div class="card">
            <strong>Quick sign up</strong>
            <p class="small">Create a local demo account stored only in your browser.</p>
            <form id="quick-signup" style="margin-top:8px">
              <input id="qs-name" placeholder="Full name" required />
              <input id="qs-email" type="email" placeholder="Email" required />
              <input id="qs-pass" type="password" placeholder="Password" required />
              <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
                <div id="pw-strength" class="pill">Strength: —</div>
                <button class="btn" style="flex:1">Create Account</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="layout">
        <div>
          <div class="card">
            <h3>About CLDcipher curriculum</h3>
            <p class="small">Deep, long-form lessons from Orientation → Fundamentals → Intermediate → Advanced → Expert tracks. All lessons emphasize ethics, defensive design, and legal safe-practices. Each lesson includes conceptual labs (sandbox placeholders in this demo), a quiz, and a discussion area.</p>
          </div>

          <div id="featured" style="margin-top:12px"></div>
        </div>

        <aside>
          <div class="card">
            <h4>Fun fact</h4>
            <div id="factBox" style="min-height:80px;display:flex;align-items:center;justify-content:center" class="small">Loading fun facts…</div>
          </div>

          <div class="card" style="margin-top:12px">
            <h4>Your profile</h4>
            <div id="profileSummary" class="small">Not signed in</div>
          </div>
        </aside>
      </div>
    </section>

    <!-- LESSONS -->
    <section id="lessons" class="app-section">
      <div class="card">
        <h2>Lessons</h2>
        <p class="small">Click 'Open' to view a lesson in full-screen mode. Each lesson is long and subdivided; take your time and use the discussion area for reflection.</p>
        <div style="margin-top:12px" id="lesson-list" class="lesson-list"></div>
      </div>
    </section>

    <!-- QUIZZES (all 20) -->
    <section id="quizzes" class="app-section">
      <div class="card">
        <h2>Quizzes</h2>
        <p class="small">All quizzes are available here — each quiz corresponds to a long lesson. You can take them as you complete lessons.</p>
        <div id="quiz-list" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- COMMUNITY -->
    <section id="community" class="app-section">
      <div class="card">
        <h2>Community</h2>
        <p class="small">Local discussion demo — posts are stored in your browser.</p>

        <div id="globalDiscussion" style="margin-top:12px" class="discussion"></div>

        <form id="globalPostForm" style="margin-top:12px">
          <input id="post-title" placeholder="Subject" required />
          <textarea id="post-body" placeholder="Write something..." rows="3" required></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" type="submit">Post</button>
            <button type="button" class="pill" onclick="clearDiscussion()">Clear</button>
          </div>
        </form>
      </div>
    </section>

    <!-- FAQ -->
    <section id="faq" class="app-section">
      <div class="card">
        <h2>FAQ</h2>
        <p class="small"><strong>Is this legal?</strong> — Always practice only in authorized environments. This demo stores data locally only.</p>
        <p class="small"><strong>Do you offer certificates?</strong> — This demo includes a local certificate placeholder; production certificates require verified capstones and instructor sign-off.</p>
      </div>
    </section>
  </main>

  <!-- Full-screen Lesson view (SPA) -->
  <div id="lessonView" class="lesson-view" role="dialog" aria-hidden="true">
    <div class="container">
      <div class="lesson-top">
        <div>
          <h2 id="lv-title">Lesson title</h2>
          <div id="lv-summary" class="small">Lesson summary</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div id="lv-progress" class="small">Progress: 0%</div>
          <button id="lv-close" class="pill">Close</button>
          <button id="lv-complete-all" class="btn">Mark All Complete</button>
        </div>
      </div>

      <div class="lesson-grid">
        <div id="lv-content">
          <!-- modules will be injected here -->
        </div>

        <aside>
          <div class="card">
            <strong>Progress</strong>
            <div id="lv-progress-text" class="small" style="margin-top:8px">0/0 modules</div>
            <div class="progress" style="margin-top:8px"><i id="lv-progress-bar" style="width:0%"></i></div>
          </div>

          <div class="card" style="margin-top:12px">
            <strong>Discussion</strong>
            <div id="lv-discussion" style="margin-top:8px" class="discussion small"></div>
            <form id="lv-post-form" style="margin-top:8px">
              <input id="lv-post-title" placeholder="Subject" required />
              <textarea id="lv-post-body" placeholder="Write a comment..." rows="3" required></textarea>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button class="btn" type="submit">Post</button>
                <button type="button" class="pill" id="lv-clear-posts">Clear</button>
              </div>
            </form>
          </div>

          <div class="card" style="margin-top:12px">
            <strong>Resources</strong>
            <div class="small" style="margin-top:8px">This demo emphasizes defensive practices and ethical behavior. Labs are sandbox placeholders.</div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <footer class="container">© cldcipher 2025</footer>

  <script>
  /* ============================
     FULL SITE SCRIPT (single-file)
     - long lessons (20) with detailed text
     - 20 quizzes (auto-grade)
     - 50 fun facts rotating
     - auth (signup/signin/reset) using localStorage (demo)
     - SPA navigation + full-screen lesson view
     ============================ */

  /* ---------- Fun facts (50) ---------- */
  const FUN_FACTS = [
    "Ethical hacker and 'white hat' are modern terms — many pioneers were hobbyists and academics.",
    "Bug bounty programs started gaining traction in the 2000s and helped make web security stronger.",
    "The term 'white hat' references old Western movies where heroes wore white hats.",
    "The Morris Worm (1988) exposed the need for better network hygiene and startlingly changed awareness.",
    "OWASP's Top 10 is a community-driven list of critical web vulnerabilities developers study widely.",
    "Capture-the-flag (CTF) competitions are one of the fastest ways to learn practical security skills.",
    "Responsible disclosure balances vendor timelines and user safety; it’s a cornerstone of ethical research.",
    "Honeypots are traps that help defenders observe attacker behavior in safe, controlled settings.",
    "Two-factor authentication (2FA) significantly reduces account takeover risk compared to passwords alone.",
    "Phishing remains one of the most effective real-world attack methods because it targets humans.",
    "Many universities now offer cybersecurity degrees including ethical hacking courses and labs.",
    "Zero-day vulnerabilities are known to attackers but not yet patched by vendors — defenders aim to reduce exposure.",
    "Content Security Policy (CSP) is a browser feature that reduces the impact of certain web attacks.",
    "Threat modeling helps teams find and prioritize risks early in software design.",
    "Secure defaults (secure-by-default) reduce accidental insecure deployments across teams.",
    "Defense in depth uses overlapping protections so single failures don't lead to compromise.",
    "SIEMs aggregate logs — good alerts are built on clear detection use-cases and tuned rules.",
    "Automated scanners reduce manual effort but often produce false positives that need triage.",
    "Secure code review is one of the highest ROI activities for reducing real vulnerabilities.",
    "Bug reports with clear reproduction steps and remediation recommendations get fixed faster.",
    "Red teaming borrows concepts from military exercises to test organizational defenses holistically.",
    "Purple teaming brings attackers and defenders together to build better detection capabilities.",
    "Browser sandboxing and process isolation evolved because researchers demonstrated exploitation paths.",
    "Secret scanning in CI/CD prevents accidental leakage of API keys and credentials in repos.",
    "Continuous integration with security checks (SAST/DAST) catches regressions before release.",
    "Many large payouts in bug bounties recognize critical vulnerabilities and motivate researchers.",
    "Responsible researchers often publish high-level writeups without providing live exploit code.",
    "Secure authentication requires more than passwords: session controls, token rotation, and MFA.",
    "Logging with context (correlation IDs, user IDs) makes incident response faster and more accurate.",
    "Ransomware motivated broad investments in backups, detection, and incident response playbooks.",
    "Network segmentation limits attacker movement and reduces the blast radius of breaches.",
    "Threat intelligence helps defenders prioritize detections for current attacker techniques.",
    "Security champions embedded in dev teams accelerate adoption of safe coding practices.",
    "Many modern security features (HSTS, CSP, secure cookies) were adopted after exploit research.",
    "Learning security improves general engineering practices like testing, observability, and design.",
    "Bug bounty programs let organizations crowdsource testing while offering legal safe paths.",
    "Some legal initiatives exist to coordinate disclosure for critical infrastructure and governments.",
    "Monitoring and alerting are as important as prevention—detection shortens dwell time.",
    "Credential stuffing attacks exploit password reuse; encouraging password managers helps mitigate.",
    "Secure deployment pipelines can use ephemeral environments to reduce exposure of secrets.",
    "Community-led resources (OWASP, CISA, SANS) provide practical guides for defenders.",
    "Ethical hacking careers include research, appsec engineering, incident response, and teaching.",
    "Many vulnerabilities are found by carefully reading code, not just with flashy tools.",
    "Security is a continuous process: training, testing, patching, detecting, and learning.",
    "Attackers and defenders co-evolve—continuous education keeps teams prepared.",
    "Small, consistent security improvements compound into significant risk reductions over time.",
    "Gamified learning (badges, micro-labs) helps learners build practical skills with feedback.",
    "A clear, well-structured vulnerability report helps vendors fix issues faster and safer.",
    "Practical security focuses on protecting users and systems, not proving clever exploits."
  ];

  let factIndex = -1;
  function rotateFact(){
    factIndex = (factIndex + 1) % FUN_FACTS.length;
    const el = document.getElementById('factBox');
    if(el) el.innerText = FUN_FACTS[factIndex];
  }
  setInterval(rotateFact, 6000);
  rotateFact();

  /* ---------- Lessons (20 long lessons) ----------
     For brevity in code, lessons are long strings. They are purposely
     conceptual and defensive. No exploit steps are provided.
  */
  const LESSONS = [
    {
      id:'L1-Orientation',
      title:'Orientation & Ethics (Comprehensive)',
      summary:'Foundational ethics, law, disclosure, and lab safety.',
      hours:6,
      content:
`Lesson overview:
This long lesson establishes the ethical foundation every learner must internalize before doing any hands-on testing. Topics include laws and jurisdictions, company responsible disclosure policies, reporting templates, and user privacy considerations.

Modules:
1) Ethics & historical context — why ethical hacking exists, famous responsible disclosures, and the social contract between researcher and vendor.
2) Legal frameworks — high-level survey of relevant laws (no legal advice): Computer Misuse Acts, CFAA, GDPR considerations when collecting data, and how jurisdiction shapes responsible behavior.
3) Scope & consent — how to obtain written authorization, what 'in-scope' vs 'out-of-scope' means, and examples of safe experiment boundaries.
4) Responsible disclosure process — timelines, redaction practices, coordinating with vendors, CVE requests, and public disclosure best-practices.
5) Privacy & data handling — how to avoid collecting or storing sensitive user data during tests, redaction and ephemeral logging.
6) Setting up an isolated lab — VM usage, snapshots, host-only networks, and tips for preserving evidence while avoiding accidental external harm.

Exercise & deliverable:
- Write a mock responsible disclosure email (template included).
- Complete a lab checklist verifying VM isolation, no public exposure, and snapshot recovery plan.`,
      quiz: {
        id:'Q1', questions:[
          { q:'Responsible disclosure primarily aims to:', choices:['Publicly embarrass vendors','Protect users by coordinating fixes','Monetize zero-days'], a:1 },
          { q:'Testing live systems without permission is:', choices:['Acceptable for learning','Potentially illegal and unethical','Recommended'], a:1 }
        ]
      }
    },

    {
      id:'L2-Networks',
      title:'Networking Deep Dive (TCP/IP & Defenders)',
      summary:'Comprehensive networking: TCP/IP, DNS, routing, packet analysis, defenders’ lens.',
      hours:14,
      content:
`This long lesson dives into networking fundamentals from a defender-focused perspective. It explains how packets flow across networks, how to read packet captures, common services and protocols (DNS, HTTP, TLS), and how defenders build network detection rules.

Modules:
1) OSI vs TCP/IP models — mapping layers to observable data.
2) IP routing & NAT — how private networks and NAT affect exposures.
3) TCP behavior — handshakes, retransmits, windowing, and indicators of reconnaissance.
4) DNS internals — query types, propagation, and common misconfigurations.
5) Packet capture analysis — using pcaps to find suspicious flows and correlating with application logs.
6) Network detection basics — signatures, anomalies, and tuning alerts.

Exercises:
- Read a provided pcap (in production) and write a detection rule for an observed suspicious flow.
- Create a list of indicators of compromise (IOCs) from simulated traffic.`,
      quiz:{
        id:'Q2', questions:[
          { q:'Which protocol is connection-oriented?', choices:['UDP','TCP','ICMP'], a:1 },
          { q:'NAT primarily affects:', choices:['Application cookies','IP addressing and routing','CPU usage'], a:1 }
        ]
      }
    },

    {
      id:'L3-OS',
      title:'Operating Systems & Hardening',
      summary:'Windows and Linux internals, permissions, system hardening, and log analysis.',
      hours:12,
      content:
`This lesson covers operating system architecture and hardening recommendations. Learn about user accounts, file systems, service management, audit logging, and configuration checks that reduce common attack vectors.

Modules:
1) Linux internals — users, sudo, file permissions, systemd basics, and common misconfigurations.
2) Windows internals — accounts, UAC, services, event logs, and common hardening settings.
3) Patch management and secure update strategies.
4) Log collection and parsing — what to log and how to parse logs for detection.
5) Configuration baselines and compliance checks.

Exercises:
- Review a sample system configuration and produce a prioritized hardening checklist.`,
      quiz:{ id:'Q3', questions:[
        { q:'Principle of least privilege means:', choices:['Grant admin to all users','Limit permissions to minimal required','Disable all accounts'], a:1 },
        { q:'System updates are important because they:', choices:['Add features only','Fix known vulnerabilities','Are optional'], a:1 }
      ]}
    },

    {
      id:'L4-WebFundamentals',
      title:'Web Fundamentals & Secure Architecture',
      summary:'HTTP, HTTPS, sessions, cookies, headers, and secure deployment patterns.',
      hours:12,
      content:
`A practical, deep web fundamentals lesson: understand HTTP methods, status codes, headers, secure cookie attributes, session management, TLS basics, and how web servers and proxies interact. Defenders must know these to write effective controls.

Modules:
1) HTTP mechanics — requests, responses, headers, methods.
2) TLS & certificates — chain validation, common deployment mistakes.
3) Session management — cookies vs tokens, secure flags, session rotation.
4) Reverse proxies, load balancers, and real-world deployment patterns.
5) Security headers and best-practices (HSTS, CSP, X-Frame-Options).

Exercises:
- Inspect example HTTP logs and identify missing security headers.`,
      quiz:{ id:'Q4', questions:[
        { q:'A secure session cookie should include:', choices:['HttpOnly & Secure','SameSite=None & no flags','Be accessible to JS'], a:0 },
        { q:'HSTS enforces:', choices:['Client-side HTTPS enforcement','Server-side only','CDN usage'], a:0 }
      ]}
    },

    {
      id:'L5-Crypto',
      title:'Cryptography Concepts for Practitioners',
      summary:'High-level cryptography: hashes, symmetric/asymmetric, TLS, key management (non-math heavy).',
      hours:8,
      content:
`This long conceptual lesson focuses on practical cryptography without deep math: which algorithms to use, how to manage keys, TLS deployment pitfalls, and why naive schemes fail in production.

Modules:
1) Hashes and integrity checks — appropriate use cases and common misuse.
2) Symmetric vs asymmetric crypto — when to use each and secure key handling.
3) TLS: ciphers, renegotiation, certificate validation problems.
4) Key rotation, storage, and vault strategies.

Exercises:
- Create a short plan to rotate keys for a web application and how to store secrets securely.`,
      quiz:{ id:'Q5', questions:[
        { q:'SHA-1 for new systems is:', choices:['Recommended','Deprecated','Mandatory'], a:1 },
        { q:'Private keys should be:', choices:['Committed to source','Stored securely in a vault','Shared with all devs'], a:1 }
      ]}
    },

    {
      id:'L6-Recon',
      title:'Reconnaissance & OSINT (Ethical)',
      summary:'Passive and active reconnaissance, OSINT tools, footprinting ethically.',
      hours:10,
      content:
`Reconnaissance is the foundation for any security assessment. This long lesson covers OSINT sources, responsible recon practices, rate-limiting considerations, and turning public info into a defensive checklist.

Modules:
1) Passive OSINT sources — DNS, certificate transparency, public repos.
2) Active discovery — scope, rate limits, and safe scanning.
3) Metadata analysis — what to look for and how to avoid collecting private data.
4) Building a defensible recon report.

Exercises:
- Produce a recon summary for a public test target using only permitted sources.`,
      quiz:{ id:'Q6', questions:[
        { q:'OSINT should be done:', choices:['Without consent','Within legal & ethical boundaries','To access private systems'], a:1 },
        { q:'Certificate Transparency logs help to:', choices:['Find issued certs for domains','Exploit servers','Replace DNS'], a:0 }
      ]}
    },

    {
      id:'L7-Scanning',
      title:'Scanning & Enumeration (Defensive View)',
      summary:'Port scanning theory, fingerprinting, dealing with false positives, and safe scan practices.',
      hours:10,
      content:
`Scanning at scale requires care. This lesson teaches scan methodologies, safe rate limits, interpreting results, and protecting your scan artifacts. We emphasize defender controls to detect and block malicious scans.

Modules:
1) Scanning types and ethics.
2) Service fingerprinting and version inference.
3) False-positive mitigation and result correlation.
4) Tuning defensive controls to avoid blocking legitimate users.

Exercises:
- Analyze a sample scan output and identify likely services and false positives.`,
      quiz:{ id:'Q7', questions:[
        { q:'A responsible scan should:', choices:['Ignore rate limits','Respect scope and rate limits','Use only destructive flags'], a:1 },
        { q:'Service fingerprinting aims to:', choices:['Identify service types/version','Exploit vulnerabilities immediately','Delete logs'], a:0 }
      ]}
    },

    {
      id:'L8-WebApp-Design',
      title:'Web Application Security — Design & Threat Modeling (Very Long)',
      summary:'Large, multi-module lesson focused on secure design, threat modeling, and defenses.',
      hours:36,
      content:
`This very long lesson is divided into multiple submodules exploring web app security from design through deployment. The focus is on detection, remediation, and secure engineering.

Submodules:
- Threat modeling & secure design — STRIDE/PASTA-style approaches to find high-value risks.
- Input validation & canonicalization — server-side validation patterns and safe libraries.
- Authentication, session management & MFA — secure flows and reset best-practices.
- Authorization & business logic protections — server-side checks and test strategies.
- Injection classes (defensive) — parameterized queries, safe API patterns.
- XSS & content security policy — output encoding and CSP strategies.
- File handling & uploads — validation, storage, and safe serving.
- Error handling & logging — avoid information leakage, log with context.
- CI/CD & dependency management — SAST/DAST, secret scanning, dependency pinning.
- Final capstone: produce a remediation plan for a sample vulnerable app.

Exercises:
- For each submodule, write a remediation checklist and implement a code-level fix in a sandbox (in production labs).`,
      quiz:{ id:'Q8', questions:[
        { q:'Threat modeling helps to:', choices:['Prioritize mitigations','Avoid all testing','Make code slower'], a:0 },
        { q:'Server-side validation should be:', choices:['Only client-side','Always enforced','Optional'], a:1 }
      ]}
    },

    {
      id:'L9-APISecurity',
      title:'API & Mobile Security (High-level)',
      summary:'Design secure REST/GraphQL APIs, token management, and mobile storage considerations.',
      hours:12,
      content:
`APIs are the backbone of modern apps. This lesson covers token rotation, scope-limited tokens, common misconfigurations, mobile secure storage considerations, and API gateway patterns.

Modules:
1) REST vs GraphQL security considerations.
2) Token-based auth, refresh tokens, and token revocation strategies.
3) Mobile platform secure storage and OS-provided mechanisms.
4) API rate limiting and defense-in-depth.

Exercise:
- Create a token revocation plan and describe how to implement it in a CI/CD environment.`,
      quiz:{ id:'Q9', questions:[
        { q:'Refresh tokens should be:', choices:['Stored insecurely','Rotated and revoked','Never used'], a:1 },
        { q:'GraphQL exposes risk when:', choices:['Unvalidated inputs allow expensive queries','Used properly','Disabled'], a:0 }
      ]}
    },

    {
      id:'L10-DefensiveMonitoring',
      title:'Defensive Controls & Log Analysis',
      summary:'SIEM basics, log collection, IDS/IPS concepts, alert tuning and triage.',
      hours:14,
      content:
`Defensive monitoring is essential to reduce dwell time. This lesson teaches log collection strategies, use-case driven alerting, detection engineering, and incident triage playbooks.

Modules:
1) Logging best practices — what to log and what not to log.
2) SIEM use-cases and rule creation.
3) IDS/IPS overview and false positive management.
4) Incident triage and playbook creation.

Exercises:
- Design an alert for suspicious lateral movement and write a triage playbook.`,
      quiz:{ id:'Q10', questions:[
        { q:'SIEM helps to:', choices:['Aggregate logs and detect patterns','Make servers insecure','Replace backups'], a:0 },
        { q:'Good alerts are:', choices:['Based on use-cases and tuned','Always noisy','Impossible to get right'], a:0 }
      ]}
    },

    // Advanced lessons 11-20 (long content continued) ...
    {
      id:'L11-VulnMgmt',
      title:'Vulnerability Management & Reporting',
      summary:'Triage, impact assessment, CVE lifecycle, and remediation verification.',
      hours:12,
      content:
`Vulnerability management bridges discovery and remediation. This lesson covers how to triage findings, writing clear remediation steps, severity vs exploitability, and verification processes.

Modules:
1) Triage methodology — exploitability vs impact matrix.
2) Writing remediation-focused reports.
3) Patch verification and regression testing.
4) CVE submission process and embargo handling.

Exercise:
- Triage a sample finding and write remediation steps prioritized by risk.`,
      quiz:{ id:'Q11', questions:[
        { q:'A strong vulnerability report includes:', choices:['Clear reproduction and remediation recommendations','Only a vague claim','Exploit code for production systems'], a:0 },
        { q:'Severity should consider:', choices:['Impact and exploitability','Only impact','Only age'], a:0 }
      ]}
    },

    {
      id:'L12-PrivEsc',
      title:'Privilege Escalation Theory & Hardening',
      summary:'Understanding common escalation paths and system hardening practices.',
      hours:10,
      content:
`Privilege escalation often stems from misconfigurations. This lesson explains common escalation vectors, defensive mitigations, and checklist-based hardening.

Modules:
- Common misconfigurations (SUID, services, weak ACLs).
- Principle of least privilege and role design.
- Hardening checklists and monitoring for abuse.

Exercise:
- Review a configuration and propose a prioritized hardening plan.`,
      quiz:{ id:'Q12', questions:[
        { q:'Principle of least privilege reduces:', choices:['Attack surface and damage','Usability only','Nothing'], a:0 },
        { q:'Hardening frequently includes:', choices:['Removing unnecessary services','Adding more default accounts','Disabling logs'], a:0 }
      ]}
    },

    {
      id:'L13-NetworkEx',
      title:'Network Exploitation Concepts (Defensive Focus)',
      summary:'Lateral movement detection, segmentation, and containment strategies.',
      hours:12,
      content:
`While offensive concepts are discussed at a high-level, defenders need to recognize lateral movement and implement containment. This long lesson covers defensive detection techniques and segmentation patterns.

Modules:
1) Detection patterns for lateral movement.
2) Network segmentation and microsegmentation.
3) Containment and playbooks.

Exercise:
- Draft a segmentation plan reducing attack surface for a web application environment.`,
      quiz:{ id:'Q13', questions:[
        { q:'Network segmentation helps to:', choices:['Limit attacker movement','Expose more services','Reduce logs'], a:0 },
        { q:'Detection of lateral movement often uses:', choices:['Process and auth logs correlation','Only firewall rules','No logs'], a:0 }
      ]}
    },

    {
      id:'L14-RedTeam',
      title:'Red Team Fundamentals (Conceptual & Ethical)',
      summary:'Engagement planning, rules of engagement, and reporting (no exploit recipes).',
      hours:16,
      content:
`Red teaming tests an organization's detection and response. This long lesson focuses on planning, safe execution, and reporting with an emphasis on improving defenses.

Modules:
- Engagement scoping and safety controls.
- Detection goals and metrics for success.
- Post-engagement reporting and remediation validation.

Exercise:
- Create a tabletop exercise and measure detection improvements.`,
      quiz:{ id:'Q14', questions:[
        { q:'Rules of engagement define:', choices:['Scope and allowed actions','How to publish exploits','Which systems to hack publicly'], a:0 },
        { q:'Red team success metrics should include:', choices:['Detection and response measures','Only whether a breach occurred','Financial gain'], a:0 }
      ]}
    },

    {
      id:'L15-Cloud',
      title:'Cloud Security (AWS/Azure/GCP — Defensive)',
      summary:'Cloud threat models, IAM best-practices, secure IaC, and tenant hardening.',
      hours:18,
      content:
`Cloud introduces new threat models. This long lesson covers IAM, least-privilege in the cloud, secure infrastructure-as-code, and how to instrument cloud environments for detection.

Modules:
- Cloud identity and access management.
- Secure IaC patterns and drift prevention.
- Instrumentation: cloud logs and detection.
- Shared-responsibility model & secure deployment.

Exercise:
- Produce an IAM policy minimizing privileges for a sample workload.`,
      quiz:{ id:'Q15', questions:[
        { q:'Cloud IAM best-practice is:', choices:['Grant broad admin rights','Use least privilege and roles','Share root credentials'], a:1 },
        { q:'Infrastructure as Code should be:', choices:['Monitored for drift and secrets','Never reviewed','Only used in prod'], a:0 }
      ]}
    },

    {
      id:'L16-AppSecEngineering',
      title:'Application Security Engineering & SDLC',
      summary:'Secure SDLC, SAST/DAST, code review checklists, and integrating security in dev workflows.',
      hours:16,
      content:
`Integrating security into engineering workflows reduces vulnerabilities earlier. This long lesson covers threat modeling in sprints, code review checklists, and automated checks in CI.

Modules:
- Secure SDLC stages and champions.
- SAST vs DAST vs dependency scanning.
- Code review guidelines and automation.

Exercise:
- Draft a secure code review checklist for your team.`,
      quiz:{ id:'Q16', questions:[
        { q:'SAST runs on:', choices:['Source code','Live traffic','User sessions'], a:0 },
        { q:'Security champions are:', choices:['Developers who promote secure practices','External auditors only','Obsolete roles'], a:0 }
      ]}
    },

    {
      id:'L17-IoT',
      title:'IoT & Embedded Security (Design Focus)',
      summary:'Threat modeling for embedded devices, secure updates and supply chain considerations.',
      hours:12,
      content:
`Hardware brings new constraints. This lesson explores secure update design, hardware root-of-trust concepts, and supply chain considerations with a defensive focus.

Modules:
- Secure boot and update strategies.
- Supply chain risk management.
- Data minimization on devices.

Exercise:
- Design a secure OTA update process outline.`,
      quiz:{ id:'Q17', questions:[
        { q:'Secure OTA updates require:', choices:['Signed images and rollbacks','No checks at all','Publishing private keys'], a:0 },
        { q:'Supply chain risk includes:', choices:['Third-party component vulnerabilities','Only hardware failures','No software concerns'], a:0 }
      ]}
    },

    {
      id:'L18-DetectionEngineering',
      title:'Detection Engineering & Purple Teaming',
      summary:'Building reliable detections, testing them with purple-team exercises, and iterating.',
      hours:14,
      content:
`Detection engineering builds measurable alerts. This lesson discusses constructing detection rules, reducing false positives, and purple-team cycles to measure detection effectiveness.

Modules:
- Creating high-fidelity detections.
- Testing detections with simulated behavior.
- Iteration and feedback loops.

Exercise:
- Implement a mock detection and measure its false-positive rate.`,
      quiz:{ id:'Q18', questions:[
        { q:'High-fidelity detections aim to:', choices:['Catch real attacks with low false positives','Trigger on every event','Ignore context'], a:0 },
        { q:'Purple team cycles help to:', choices:['Improve detection with attacker insight','Break teams','Slow development'], a:0 }
      ]}
    },

    {
      id:'L19-ResearchEthics',
      title:'Security Research & Responsible Publication',
      summary:'How to research ethically, write safe disclosures, and publish responsibly.',
      hours:10,
      content:
`Publishing research helps the community but must be done responsibly. This lesson covers safe disclosure timelines, redaction, and coordinating with vendors.

Modules:
- Ethics of publishing vulnerabilities.
- Redaction and responsible timelines.
- Working with vendors and CVE authorities.

Exercise:
- Draft an ethical research disclosure plan.`,
      quiz:{ id:'Q19', questions:[
        { q:'Responsible publication often includes:', choices:['Vendor coordination and redaction','Immediate exploit release','Selling details'], a:0 },
        { q:'CVE assignment helps to:', choices:['Standardize tracking of vulnerabilities','Hide issues','Prevent fixes'], a:0 }
      ]}
    },

    {
      id:'L20-Capstone',
      title:'Capstone: Defensive Program Design',
      summary:'Design a defensible program integrating lessons learned and measurable metrics.',
      hours:20,
      content:
`Capstone challenge: build a defensible security program for a hypothetical company. Include threat models, detection plans, hardening checklists, and training/metrics to measure success.

Deliverables:
- Threat model & prioritized mitigation backlog.
- Detection & response playbook for a selected threat.
- Patch & deployment hardening checklist.
- Training plan for dev teams.

This capstone synthesizes the entire curriculum into a practical program.`,
      quiz:{ id:'Q20', questions:[
        { q:'A defensible program includes:', choices:['Detection, response, and prevention','Only prevention','Only audits'], a:0 },
        { q:'Measurable security metrics help to:', choices:['Track improvement and ROI','Hide performance','Avoid change'], a:0 }
      ]}
    }
  ];

  /* ---------- Storage & Auth utils ---------- */
  function loadAccounts(){ try{return JSON.parse(localStorage.getItem('cldc_accounts')||'{}')}catch(e){return{}} }
  function saveAccounts(obj){ localStorage.setItem('cldc_accounts', JSON.stringify(obj)) }
  function getLogged(){ return localStorage.getItem('cldc_logged') || null }
  function setLogged(email){ localStorage.setItem('cldc_logged', email); renderProfile(); }
  function clearLogged(){ localStorage.removeItem('cldc_logged'); renderProfile(); }

  function esc(s){ return String(s||'').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[ch])); }

  /* ---------- Render lesson list & featured ---------- */
  const lessonListEl = document.getElementById('lesson-list');
  const featuredEl = document.getElementById('featured');
  const quizListEl = document.getElementById('quiz-list');

  function renderLessons(){
    lessonListEl.innerHTML = '';
    LESSONS.forEach(l => {
      const div = document.createElement('div');
      div.className = 'lesson-item';
      div.innerHTML = `<div>
          <strong>${esc(l.title)}</strong>
          <div class="small">${esc(l.summary)} · ${l.hours} hrs</div>
        </div>
        <div class="lesson-actions">
          <div class="small">${l.modules ? l.modules.length : '—'} modules</div>
          <div style="display:flex;gap:6px">
            <button class="pill" onclick="openLesson('${l.id}')">Open</button>
            <button class="pill" onclick="enroll('${l.id}')">Enroll</button>
          </div>
        </div>`;
      lessonListEl.appendChild(div);
    });

    // featured (first three)
    featuredEl.innerHTML = '';
    LESSONS.slice(0,3).forEach(l => {
      const c = document.createElement('div');
      c.className = 'card'; c.style.marginTop='10px';
      c.innerHTML = `<strong>${esc(l.title)}</strong><div class="small" style="margin-top:6px">${esc(l.summary)}</div><div style="margin-top:8px"><button class="btn" onclick="openLesson('${l.id}')">Open Lesson</button></div>`;
      featuredEl.appendChild(c);
    });

    // quizzes list
    quizListEl.innerHTML = '';
    LESSONS.forEach((l, idx) => {
      if(!l.quiz || !l.quiz.id) {
        // lessons may still have quiz as defined above
      }
      const qdiv = document.createElement('div');
      qdiv.className = 'lesson-item';
      qdiv.innerHTML = `<div><strong>Quiz ${idx+1}: ${esc(l.title)}</strong><div class="small">${esc(l.summary)}</div></div><div style="display:flex;gap:6px"><button class="pill" onclick="openQuiz('${l.id}')">Take Quiz</button></div>`;
      quizListEl.appendChild(qdiv);
    });
  }
  renderLessons();

  /* ---------- Enrollment & profile ---------- */
  function enroll(lessonId){
    const user = getLogged();
    if(!user){ alert('Please sign in to enroll.'); return; }
    const accounts = loadAccounts();
    accounts[user].enrolled = accounts[user].enrolled || [];
    if(!accounts[user].enrolled.includes(lessonId)){ accounts[user].enrolled.push(lessonId); saveAccounts(accounts); alert('Enrolled: ' + lessonId); renderProfile(); }
    else alert('Already enrolled.');
  }

  function renderProfile(){
    const out = document.getElementById('profileSummary');
    const logged = getLogged();
    if(!logged){ out.innerHTML = 'Not signed in'; return; }
    const accounts = loadAccounts();
    const user = accounts[logged];
    if(!user){ out.innerHTML = 'Not signed in'; return; }
    const completed = (user.completed||[]).length;
    const enrolled = (user.enrolled||[]).length;
    out.innerHTML = `<strong>${esc(user.name)}</strong><div class="small">${esc(user.email)}</div><div style="margin-top:8px" class="small">Enrolled: ${enrolled} · Completed modules: ${completed} · <button class="pill" onclick="signOut()">Sign out</button></div>`;
  }
  function signOut(){ clearLogged(); alert('Signed out'); }

  /* ---------- SPA navigation ---------- */
  document.querySelectorAll('nav .nav-btn').forEach(btn => btn.addEventListener('click', ()=> navigateTo(btn.dataset.target)));
  function navigateTo(id){ document.querySelectorAll('section.app-section').forEach(s=> s.classList.remove('active')); const el=document.getElementById(id); if(el) el.classList.add('active'); window.scrollTo({top:0,behavior:'smooth'}); }

  /* CTA */
  document.getElementById('cta-enroll').addEventListener('click', ()=> { if(!getLogged()){ document.getElementById('btn-signup').click(); return; } navigateTo('lessons'); });

  /* ---------- Quick sign up / password strength ---------- */
  document.getElementById('quick-signup').addEventListener('submit', e=>{
    e.preventDefault();
    const name = document.getElementById('qs-name').value.trim();
    const email = document.getElementById('qs-email').value.trim().toLowerCase();
    const pass = document.getElementById('qs-pass').value;
    if(!name||!email||!pass){ alert('Fill all fields'); return; }
    const acc = loadAccounts();
    if(acc[email]){ alert('Account exists'); return; }
    acc[email] = { name, email, password:pass, completed:[], enrolled:[] };
    saveAccounts(acc);
    setLogged(email);
    alert('Account created and signed in');
  });

  function passwordStrength(pw){
    if(!pw) return {score:0,label:'—'};
    let s=0; if(pw.length>=8) s++; if(/[a-z]/.test(pw)&&/[A-Z]/.test(pw)) s++; if(/[0-9]/.test(pw)) s++; if(/[^A-Za-z0-9]/.test(pw)) s++;
    const labels=['Very weak','Weak','Okay','Strong','Very strong']; return {score:s,label:labels[s]||'Very weak'};
  }
  document.getElementById('qs-pass').addEventListener('input', e => { document.getElementById('pw-strength').innerText = 'Strength: ' + passwordStrength(e.target.value).label; });

  /* ---------- Sign in / Sign up buttons open an overlay lessonView used as auth area (SPA) ---------- */
  document.getElementById('btn-signup').addEventListener('click', ()=> openAuth('signup'));
  document.getElementById('btn-login').addEventListener('click', ()=> openAuth('signin'));

  function openAuth(mode){
    // show lessonView and inject a small auth form
    const view = document.getElementById('lessonView');
    view.style.display='block';
    view.setAttribute('aria-hidden','false');
    document.getElementById('lv-title').innerText = (mode==='signup')? 'Sign Up' : 'Sign In';
    document.getElementById('lv-summary').innerText = '';
    document.getElementById('lv-content').innerHTML = `<div class="card"><form id="auth-form">
      ${mode==='signup'?'<input id="auth-name" placeholder="Full name" required />':''}
      <input id="auth-email" type="email" placeholder="Email" required />
      <input id="auth-pass" type="password" placeholder="Password" required />
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" type="submit">${mode==='signup'?'Create Account':'Sign In'}</button>
        <button type="button" class="pill" id="auth-cancel">Cancel</button>
        ${mode==='signin'?'<button type="button" class="pill" id="auth-forgot">Forgot</button>':''}
      </div></form></div>`;
    document.getElementById('lv-close').onclick = ()=> { view.style.display='none'; view.setAttribute('aria-hidden','true'); };
    document.getElementById('auth-cancel').addEventListener('click', ()=> { view.style.display='none'; view.setAttribute('aria-hidden','true'); });

    if(mode==='signup'){
      document.getElementById('auth-form').addEventListener('submit', e=>{
        e.preventDefault();
        const name = document.getElementById('auth-name').value.trim();
        const email = document.getElementById('auth-email').value.trim().toLowerCase();
        const pass = document.getElementById('auth-pass').value;
        if(!name||!email||!pass){ alert('Fill all fields'); return; }
        const acc = loadAccounts();
        if(acc[email]){ alert('Account exists'); return; }
        acc[email] = { name, email, password:pass, completed:[], enrolled:[] };
        saveAccounts(acc);
        setLogged(email);
        alert('Account created and signed in');
        view.style.display='none'; view.setAttribute('aria-hidden','true');
      });
    } else {
      document.getElementById('auth-form').addEventListener('submit', e=>{
        e.preventDefault();
        const email = document.getElementById('auth-email').value.trim().toLowerCase();
        const pass = document.getElementById('auth-pass').value;
        const acc = loadAccounts();
        if(!acc[email] || acc[email].password !== pass){ alert('Invalid credentials'); return; }
        setLogged(email);
        alert('Signed in');
        view.style.display='none'; view.setAttribute('aria-hidden','true');
      });
      document.getElementById('auth-forgot').addEventListener('click', showForgot);
    }
  }

  function showForgot(){
    const view = document.getElementById('lessonView'); view.style.display='block'; view.setAttribute('aria-hidden','false');
    document.getElementById('lv-title').innerText='Forgot Password';
    document.getElementById('lv-summary').innerText='';
    document.getElementById('lv-content').innerHTML = `<div class="card"><form id="fp-form"><div class="small">Enter your email to receive a demo reset token (displayed). In production you'd email it.</div><input id="fp-email" type="email" placeholder="Email" required /><div style="display:flex;gap:8px;margin-top:8px"><button class="btn" type="submit">Send Token</button><button type="button" class="pill" id="fp-cancel">Cancel</button></div></form></div>`;
    document.getElementById('fp-cancel').addEventListener('click', ()=> { view.style.display='none'; view.setAttribute('aria-hidden','true'); });
    document.getElementById('fp-form').addEventListener('submit', e=>{
      e.preventDefault();
      const email = document.getElementById('fp-email').value.trim().toLowerCase();
      const acc = loadAccounts();
      if(!acc[email]){ alert('No account found'); return; }
      const token = Math.random().toString(36).slice(2,9).toUpperCase();
      acc[email].resetToken = token; saveAccounts(acc);
      alert('Demo reset token: ' + token + '\\nUse Reset password to set a new password.');
      showReset(email);
    });
  }

  function showReset(prefill){
    const view = document.getElementById('lessonView'); view.style.display='block'; view.setAttribute('aria-hidden','false');
    document.getElementById('lv-title').innerText='Reset Password';
    document.getElementById('lv-summary').innerText='';
    document.getElementById('lv-content').innerHTML = `<div class="card"><form id="rt-form"><input id="rt-email" type="email" value="${esc(prefill||'')}" required /><input id="rt-token" placeholder="Token" required /><input id="rt-pass" type="password" placeholder="New password" required /><div style="display:flex;gap:8px;margin-top:8px"><button class="btn" type="submit">Reset</button><button type="button" class="pill" id="rt-cancel">Cancel</button></div></form></div>`;
    document.getElementById('rt-cancel').addEventListener('click', ()=> { view.style.display='none'; view.setAttribute('aria-hidden','true'); });
    document.getElementById('rt-form').addEventListener('submit', e=>{
      e.preventDefault();
      const em = document.getElementById('rt-email').value.trim().toLowerCase();
      const tkn = document.getElementById('rt-token').value.trim();
      const np = document.getElementById('rt-pass').value;
      const acc = loadAccounts();
      if(!acc[em] || acc[em].resetToken !== tkn){ alert('Invalid token or email'); return; }
      acc[em].password = np; delete acc[em].resetToken; saveAccounts(acc);
      alert('Password reset - sign in with new password.');
      view.style.display='none'; view.setAttribute('aria-hidden','true');
    });
  }

  /* ---------- Discussion global ---------- */
  function loadDiscussion(){ try{return JSON.parse(localStorage.getItem('cldc_discussion')||'[]')}catch(e){return[]} }
  function saveDiscussion(arr){ localStorage.setItem('cldc_discussion', JSON.stringify(arr)) }
  function renderGlobalDiscussion(){
    const el = document.getElementById('globalDiscussion'); el.innerHTML='';
    const posts = loadDiscussion();
    posts.slice().reverse().forEach(p => {
      const d = document.createElement('div'); d.className='post';
      d.innerHTML = `<div style="display:flex;justify-content:space-between"><strong>${esc(p.title)}</strong><div class="small">${esc(p.by)} · ${new Date(p.date).toLocaleString()}</div></div><div class="small" style="margin-top:6px">${esc(p.body)}</div>`;
      el.appendChild(d);
    });
  }
  document.getElementById('globalPostForm').addEventListener('submit', e=> {
    e.preventDefault();
    const t = document.getElementById('post-title').value.trim(); const b = document.getElementById('post-body').value.trim();
    if(!t||!b) return alert('Fill both fields');
    const posts = loadDiscussion(); posts.push({title:t, body:b, by: getLogged()? loadAccounts()[getLogged()].name : 'Guest', date: new Date().toISOString()}); saveDiscussion(posts);
    document.getElementById('post-title').value=''; document.getElementById('post-body').value=''; renderGlobalDiscussion();
  });
  function clearDiscussion(){ if(confirm('Clear all discussion posts?')){ saveDiscussion([]); renderGlobalDiscussion(); } }
  renderGlobalDiscussion();

  /* ---------- Lesson opening / full-screen ---------- */
  const lessonView = document.getElementById('lessonView');
  const lvTitle = document.getElementById('lv-title');
  const lvSummary = document.getElementById('lv-summary');
  const lvContent = document.getElementById('lv-content');
  const lvClose = document.getElementById('lv-close');
  const lvProgressText = document.getElementById('lv-progress-text');
  const lvProgressBar = document.getElementById('lv-progress-bar');

  lvClose.addEventListener('click', ()=> { lessonView.style.display='none'; lessonView.setAttribute('aria-hidden','true'); });

  function openLesson(lessonId){
    const lesson = LESSONS.find(x => x.id === lessonId);
    if(!lesson) return alert('Lesson not found');
    lessonView.style.display='block'; lessonView.setAttribute('aria-hidden','false');
    lvTitle.innerText = lesson.title; lvSummary.innerText = lesson.summary;
    // build long content - include the whole lesson.content text and submodules if any
    let html = `<div class="card"><strong>Estimated time:</strong> <span class="small">${lesson.hours} hours (approx)</span><div style="margin-top:10px;white-space:pre-wrap" class="small">${esc(lesson.content)}</div></div>`;
    // Add modules or submodules if structured (some lessons include multi-submodule content inside content)
    // For our data, content includes submodule narrative; still, allow marking completion per 'pseudo-module'
    // We'll derive module units: split content by newline headings (simple heuristic)
    const units = deriveUnits(lesson);
    html += `<div style="margin-top:12px">${units.map(u => `<div class="module"><div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${esc(u.title)}</strong><div class="small" style="margin-top:6px;white-space:pre-wrap">${esc(u.body)}</div></div><div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end"><button class="pill" onclick="openModule('${lesson.id}','${u.id}')">Open</button><button class="pill" onclick="toggleComplete('${lesson.id}::${u.id}')">${isDone(lesson.id + '::' + u.id)?'Mark undone':'Mark done'}</button></div></div></div>`).join('')}</div>`;

    // Quiz link for this lesson
    html += `<div style="margin-top:12px" class="card"><strong>Lesson Quiz</strong><div class="small" style="margin-top:8px">${esc(lesson.summary)}</div><div style="margin-top:8px"><button class="btn" onclick="openQuiz('${lesson.id}')">Take Quiz</button></div></div>`;

    lvContent.innerHTML = html;

    // discussion rendering
    renderLessonDiscussion(lesson.id);
    document.getElementById('lv-post-form').onsubmit = (e) => { e.preventDefault(); const t=document.getElementById('lv-post-title').value.trim(), b=document.getElementById('lv-post-body').value.trim(); if(!t||!b) return alert('Fill both fields'); addLessonPost(lesson.id,t,b); document.getElementById('lv-post-title').value=''; document.getElementById('lv-post-body').value=''; renderLessonDiscussion(lesson.id); };
    document.getElementById('lv-clear-posts').onclick = ()=> { if(confirm('Clear lesson posts?')){ clearLessonPosts(lesson.id); renderLessonDiscussion(lesson.id); }};

    updateLessonProgress(lesson.id);
  }

  // simple deriveUnits: split content into paragraphs and make few units (heuristic)
  function deriveUnits(lesson){
    // If lesson has explicit submodules in data (e.g., lesson.submodules), use them
    if(lesson.submodules) return lesson.submodules.map((s,i)=> ({ id: (s.id||('m'+i)), title: s.title||('Module '+(i+1)), body: s.body||'' }));
    // else split by double newlines into 3 units
    const parts = String(lesson.content||'').split('\n\n').filter(p=>p.trim()).slice(0,6);
    return parts.map((p,i)=> ({ id:'u'+(i+1), title:'Part '+(i+1), body:p }));
  }

  function openModule(lessonId, unitId){
    // open a focused module view within the lessonView
    const unitKey = `${lessonId}::${unitId}`;
    const unitDone = isDone(unitKey);
    const area = lvContent;
    // find unit text from deriveUnits
    const lesson = LESSONS.find(x=>x.id===lessonId); if(!lesson) return;
    const unit = deriveUnits(lesson).find(u=>u.id===unitId) || {title:unitId, body:''};
    area.innerHTML = `<div class="card"><strong>${esc(unit.title)}</strong><div class="small" style="margin-top:8px;white-space:pre-wrap">${esc(unit.body)}</div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn" id="mod-toggle">${unitDone? 'Mark undone':'Mark done'}</button>
        <button class="pill" id="mod-lab">Practice Lab</button>
        <button class="pill" id="mod-back">Back to lesson</button>
      </div>
      <div id="mod-area" style="margin-top:12px"></div>
    </div>`;
    document.getElementById('mod-back').addEventListener('click', ()=> openLesson(lessonId));
    document.getElementById('mod-toggle').addEventListener('click', ()=> { toggleComplete(unitKey); openModule(lessonId, unitId); updateLessonProgress(lessonId); });
    document.getElementById('mod-lab').addEventListener('click', ()=> {
      const a = document.getElementById('mod-area');
      a.innerHTML = `<div class="card"><strong>Practice Lab (demo)</strong><div class="small" style="margin-top:6px">This is a sandbox placeholder for lab work. In production labs are isolated containers or VMs.</div><textarea id="lab-note" rows="4" placeholder="Write remediation notes or observations..." style="width:100%;margin-top:8px"></textarea><div style="margin-top:8px;display:flex;gap:8px"><button class="btn" id="lab-save">Save Note</button></div></div>`;
      document.getElementById('lab-save').addEventListener('click', ()=> { const note=document.getElementById('lab-note').value.trim(); if(!note) return alert('Write something'); saveLabNote(unitKey, note); alert('Lab note saved (demo).'); });
    });
  }

  /* ---------- Simple progress storage ---------- */
  function saveLabNote(key, note){
    const user = getLogged(); if(!user) return alert('Sign in to save labs');
    const acc = loadAccounts(); acc[user].labs = acc[user].labs || {}; acc[user].labs[key] = acc[user].labs[key] || []; acc[user].labs[key].push({note,date:new Date().toISOString()}); saveAccounts(acc);
  }

  function toggleComplete(key){
    const user = getLogged(); if(!user) return alert('Sign in to track progress');
    const acc = loadAccounts(); acc[user].completed = acc[user].completed||[]; const idx = acc[user].completed.indexOf(key); if(idx>=0) acc[user].completed.splice(idx,1); else acc[user].completed.push(key); saveAccounts(acc);
  }
  function isDone(key){
    const user = getLogged(); if(!user) return false; const acc = loadAccounts(); return (acc[user].completed||[]).includes(key);
  }

  function updateLessonProgress(lessonId){
    const lesson = LESSONS.find(l=>l.id===lessonId); if(!lesson) return;
    const units = deriveUnits(lesson);
    const total = units.length;
    const user = getLogged();
    let done = 0;
    if(user){
      const acc = loadAccounts();
      units.forEach(u => { if(acc[user].completed && acc[user].completed.includes(lessonId+'::'+u.id)) done++; });
    }
    const pct = Math.round((done/Math.max(total,1))*100);
    lvProgressText.innerText = `${done}/${total} modules complete (${pct}%)`;
    lvProgressBar.style.width = pct + '%';
    document.getElementById('lv-progress').innerText = `Progress: ${pct}%`;
    renderProfile();
  }

  /* ---------- Lesson discussion storage ---------- */
  function lessonKey(lessonId){ return 'cldc_lesson_posts_' + lessonId; }
  function loadLessonPosts(lessonId){ try{return JSON.parse(localStorage.getItem(lessonKey(lessonId))||'[]')}catch(e){return[]} }
  function saveLessonPosts(lessonId, arr){ localStorage.setItem(lessonKey(lessonId), JSON.stringify(arr)) }
  function addLessonPost(lessonId, title, body){ const arr = loadLessonPosts(lessonId); arr.push({title,body,by:getLogged()? loadAccounts()[getLogged()].name : 'Guest',date:new Date().toISOString()}); saveLessonPosts(lessonId,arr); }
  function clearLessonPosts(lessonId){ saveLessonPosts(lessonId, []); }
  function renderLessonDiscussion(lessonId){
    const container = document.getElementById('lv-discussion'); if(!container) return;
    const posts = loadLessonPosts(lessonId);
    container.innerHTML = '';
    posts.slice().reverse().forEach(p => {
      const n = document.createElement('div'); n.className='post'; n.innerHTML = `<div style="display:flex;justify-content:space-between"><strong>${esc(p.title)}</strong><div class="small">${esc(p.by)} · ${new Date(p.date).toLocaleString()}</div></div><div class="small" style="margin-top:6px">${esc(p.body)}</div>`;
      container.appendChild(n);
    });
  }

  /* ---------- Quizzes: one per lesson (20) ---------- */
  // LESSONS already include .quiz objects where defined; ensure all 20 have quiz definitions (we added earlier)
  // openQuiz renders the quiz and grades answers
  function openQuiz(lessonId){
    const lesson = LESSONS.find(l => l.id === lessonId);
    if(!lesson) return alert('Quiz not found');
    lessonView.style.display='block'; lessonView.setAttribute('aria-hidden','false');
    lvTitle.innerText = 'Quiz: ' + lesson.title; lvSummary.innerText = lesson.summary;
    // render quiz
    const quiz = lesson.quiz;
    if(!quiz || !quiz.questions || !quiz.questions.length){
      lvContent.innerHTML = `<div class="card"><strong>No quiz available</strong><div class="small">This lesson has no auto-graded quiz in the demo.</div></div>`;
      return;
    }
    let html = `<div class="quiz-card"><form id="quiz-form"><div class="small">Answer the multiple-choice questions below. Immediate grading will show your score.</div><div style="margin-top:12px">`;
    quiz.questions.forEach((q,i) => {
      html += `<div class="quiz-question"><div><strong>Q${i+1}.</strong> ${esc(q.q)}</div>`;
      q.choices.forEach((c,j) => { html += `<div style="margin-top:6px"><label><input type="radio" name="q${i}" value="${j}" /> ${esc(c)}</label></div>`; });
      html += `</div>`;
    });
    html += `</div><div style="display:flex;gap:8px;margin-top:12px"><button class="btn" type="submit">Submit Quiz</button><button type="button" class="pill" id="quiz-cancel">Cancel</button></div></form><div id="quiz-result" style="margin-top:12px"></div></div>`;
    lvContent.innerHTML = html;
    document.getElementById('quiz-cancel').addEventListener('click', ()=> { lessonView.style.display='none'; lessonView.setAttribute('aria-hidden','true'); });
    document.getElementById('quiz-form').addEventListener('submit', e=> {
      e.preventDefault();
      let score = 0;
      quiz.questions.forEach((q,i) => { const el = e.target[`q${i}`]; const val = el ? el.value : null; if(String(val) === String(q.a)) score++; });
      const pct = Math.round(score / quiz.questions.length * 100);
      document.getElementById('quiz-result').innerHTML = `<div class="card"><strong>Your result</strong><div class="small" style="margin-top:8px">${score}/${quiz.questions.length} (${pct}%)</div></div>`;
      // store result in account if logged in
      const user = getLogged(); if(user){ const acct = loadAccounts(); acct[user].quizResults = acct[user].quizResults || {}; acct[user].quizResults[lessonId] = {score, outOf: quiz.questions.length, pct, date:new Date().toISOString()}; saveAccounts(acct); }
    });
  }

  /* ---------- Global helpers & init ---------- */
  function loadAccounts(){ try{return JSON.parse(localStorage.getItem('cldc_accounts')||'{}')}catch(e){return{}} }
  function saveAccounts(obj){ localStorage.setItem('cldc_accounts', JSON.stringify(obj)) }
  function getLogged(){ return localStorage.getItem('cldc_logged') || null }
  function setLogged(email){ localStorage.setItem('cldc_logged', email); renderProfile(); }
  function clearLogged(){ localStorage.removeItem('cldc_logged'); renderProfile(); }

  // fill initial demo account if none exists (optional)
  (function ensureDemo(){
    const acc = loadAccounts();
    if(!Object.keys(acc).length){
      acc['demo@cldcipher.test'] = { name:'Demo User', email:'demo@cldcipher.test', password:'DemoPass1!', completed:[], enrolled:[], labs:{}, quizResults:{} };
      saveAccounts(acc);
    }
  })();

  renderProfile();

  // close lessonView on Escape
  document.addEventListener('keydown', e=> { if(e.key === 'Escape'){ lessonView.style.display='none'; lessonView.setAttribute('aria-hidden','true'); } });

  // initial render of lessons and quizzes
  renderLessons();

  </script>
</body>
</html>
